<!DOCTYPE html>
<head>
	<meta charset="UTF-8">
	 <meta name="viewport" 
          content="initial-scale=1.0,
                   maximum-scale=1.0">
     <title>随机抽取题组号</title>
      <link href="css/elementui.min.css" rel="stylesheet">
		 <!-- <script type="text/javascript" src="js/vue.min.js"></script> -->
		 <script type="text/javascript" src="js/vue.js"></script>
		 <script type="text/javascript" src="js/elementui.min.js"></script>
		 <script type="text/javascript" src="js/js-xlsx/xlsx.full.min.js"></script>
		 <script type="text/javascript" src="js/utils/formatdate.js"></script>

		 <script type="text/javascript" src="js/vendor/FileSaver.min.js"></script>
		 <script type="text/javascript" src="js/vendor/Blob.js"></script>
		 <script type="text/javascript" src="js/vendor/Export2Excel.js"></script>

</head>
<body>
	<div id="app">	
		<div class="app-container">
			<upload-excel-component :on-success='handleSuccess' :before-upload="beforeUpload"></upload-excel-component>
			<el-table :data="tableData" border highlight-current-row style="width: 100%;margin-top:20px;">
				<el-table-column v-for='item of tableHeader' :prop="item" :label="item" :key='item'>
				</el-table-column>
			</el-table>
		</div>
	
		<div>
			<el-button type="primary" @click="handleDownload">导出Excel</el-button>		
		</div>
	</div>
	
	<script>	
				// 定义名为 UploadExcelComponent 的新组件 实现上传文件的功能
		Vue.component('UploadExcelComponent', {
			props: {
				beforeUpload: Function,
				onSuccess: Function
			},
			data() {		
				return {
					loading: false,
					excelData: {
						header: null,
						results: null
					}			
				}					
			},
			template: '<div>\
			<input id="excel-upload-input" ref="excel-upload-input" type="file" accept=".xlsx, .xls" @change="handleClick">\
			<div id="drop" @drop="handleDrop" @dragover="handleDragover" @dragenter="handleDragover">\
				Drop excel file here or\
				<el-button :loading="loading" style="margin-left:16px;" size="mini" type="primary" @click="handleUpload">Browse</el-button>\
			</div>\
			</div>',
			methods: {
				generateDate({ header, results }) {
					this.excelData.header = header
					this.excelData.results = results
					this.onSuccess && this.onSuccess(this.excelData)
				},
				handleDrop(e) {
					e.stopPropagation()
					e.preventDefault()
					if (this.loading) return
					const files = e.dataTransfer.files
					if (files.length !== 1) {
						this.$message.error('Only support uploading one file!')
						return
					}
					const rawFile = files[0] // only use files[0]

					if (!this.isExcel(rawFile)) {
						this.$message.error('Only supports upload .xlsx, .xls, .csv suffix files')
						return false
					}
					this.upload(rawFile)
					e.stopPropagation()
					e.preventDefault()
				},
				handleDragover(e) {
					e.stopPropagation()
					e.preventDefault()
					e.dataTransfer.dropEffect = 'copy'
				},
				handleUpload() {
					document.getElementById('excel-upload-input').click()
				},
				handleClick(e) {
					const files = e.target.files
					const rawFile = files[0] // only use files[0]
					if (!rawFile) return
					this.upload(rawFile)
				},
				upload(rawFile) {
					this.$refs['excel-upload-input'].value = null // fix can't select the same excel

					if (!this.beforeUpload) {
						this.readerData(rawFile)
						return
					}
					const before = this.beforeUpload(rawFile)
					if (before) {
						this.readerData(rawFile)
					}
				},
				readerData(rawFile) {
					this.loading = true
					return new Promise((resolve, reject) => {
						const reader = new FileReader()
						reader.onload = e => {
							const data = e.target.result
							const fixedData = this.fixdata(data)
							const workbook = XLSX.read(btoa(fixedData), { type: 'base64' })
							const firstSheetName = workbook.SheetNames[0]
							const worksheet = workbook.Sheets[firstSheetName]
							const header = this.get_header_row(worksheet)
							const results = XLSX.utils.sheet_to_json(worksheet)
							this.generateDate({ header, results })
							this.loading = false
							resolve()
						}
						reader.readAsArrayBuffer(rawFile)
					})
				},
				fixdata(data) {
					let o = ''
					let l = 0
					const w = 10240
					for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)))
					o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)))
					return o
				},
				get_header_row(sheet) {
					const headers = []
					const range = XLSX.utils.decode_range(sheet['!ref'])
					let C
					const R = range.s.r /* start in the first row */
					for (C = range.s.c; C <= range.e.c; ++C) { /* walk every column in the range */
						var cell = sheet[XLSX.utils.encode_cell({ c: C, r: R })] /* find the cell in the first row */
						var hdr = 'UNKNOWN ' + C // <-- replace with your desired default
						if (cell && cell.t) hdr = XLSX.utils.format_cell(cell)
						headers.push(hdr)
					}
					return headers
				},
				isExcel(file) {
					return /\.(xlsx|xls|csv)$/.test(file.name)
				}				
			}
		})
		const app = new Vue({
			el:"#app",
			data:{			
				tableData: [],
				tableHeader: [],
				filename: 'Test',
				autoWidth: true
			},
			computed: {
				
			},
			methods:{
				beforeUpload(file) {
					const isLt1M = file.size / 1024 / 1024 < 1

					if (isLt1M) {
						return true
					}

					this.$message({
						message: 'Please do not upload files larger than 1m in size.',
						type: 'warning'
					})
					return false
				},
				handleSuccess({ results, header }) {
					this.tableData = results
					this.tableHeader = header
				},
				handleDownload() {
					const tHeader = this.tableHeader
					const filterVal = tHeader
					const list = this.tableData
					const data = this.formatJson(filterVal, list)
					export_json_to_excel({
						header: tHeader,
						data,
						filename: this.filename,
						autoWidth: this.autoWidth
					})
				},
				formatJson(filterVal, jsonData) {
					return jsonData.map(v => filterVal.map(j => {
						if (j === 'timestamp') {
							return parseTime(v[j])
						} else {
							return v[j]
						}
					}))
				}			
			},
			mounted() {
				
			}
		});

	</script>
	<style>
		#excel-upload-input{
		display: none;
		z-index: -9999;
		}
		#drop{
			border: 2px dashed #bbb;
			width: 600px;
			height: 160px;
			line-height: 160px;
			margin: 0 auto;
			font-size: 24px;
			border-radius: 5px;
			text-align: center;
			color: #bbb;
			position: relative;
		}
	</style>
</body>